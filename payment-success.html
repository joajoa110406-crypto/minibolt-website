<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>결제 완료 - MiniBolt</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;color:#333;background:#f5f5f5;display:flex;align-items:center;justify-content:center;min-height:100vh}
.container{background:#fff;border-radius:15px;padding:3rem;box-shadow:0 4px 20px rgba(0,0,0,0.1);max-width:600px;width:100%;text-align:center}
.success-icon{font-size:5rem;color:#28a745;margin-bottom:1rem;animation:scaleIn 0.5s ease-out}
@keyframes scaleIn{from{transform:scale(0)}to{transform:scale(1)}}
h1{font-size:2rem;color:#28a745;margin-bottom:1rem}
.subtitle{color:#666;margin-bottom:2rem;font-size:1.1rem}
.order-info{background:#f8f9fa;border-radius:10px;padding:1.5rem;margin:2rem 0;text-align:left}
.info-row{display:flex;justify-content:space-between;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid #dee2e6}
.info-row:last-child{border-bottom:none;margin-bottom:0}
.info-label{color:#666;font-weight:600}
.info-value{font-weight:700;color:#2c3e50}
.amount{font-size:1.5rem;color:#ff6b35}
.buttons{display:flex;gap:1rem;margin-top:2rem}
.btn{padding:1rem 2rem;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;transition:all .3s;flex:1;text-decoration:none;display:inline-block}
.btn-primary{background:#ff6b35;color:#fff}
.btn-primary:hover{background:#e55a28}
.btn-secondary{background:#6c757d;color:#fff}
.btn-secondary:hover{background:#5a6268}
.loading{display:none}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #ff6b35;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 1rem}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">
<div class="loading" id="loading">
<div class="spinner"></div>
<h2 style="color:#ff6b35">결제 승인 중...</h2>
<p style="color:#666">잠시만 기다려주세요</p>
</div>

<div id="success-content" style="display:none">
<div class="success-icon">
<i class="fa-solid fa-circle-check"></i>
</div>
<h1>결제가 완료되었습니다!</h1>
<p class="subtitle">주문이 정상적으로 접수되었습니다.</p>

<div class="order-info">
<div class="info-row">
<span class="info-label">주문번호</span>
<span class="info-value" id="order-id">-</span>
</div>
<div class="info-row">
<span class="info-label">결제방법</span>
<span class="info-value" id="payment-method">-</span>
</div>
<div class="info-row">
<span class="info-label">결제금액</span>
<span class="info-value amount" id="amount">₩0</span>
</div>
<div class="info-row">
<span class="info-label">주문자</span>
<span class="info-value" id="buyer-name">-</span>
</div>
</div>

<p style="color:#666;margin-bottom:1rem">
<i class="fa-solid fa-info-circle"></i>
주문 내역은 이메일로 발송되었습니다.
</p>

<div class="buttons">
<a href="index.html" class="btn btn-primary">홈으로</a>
<a href="products.html" class="btn btn-secondary">계속 쇼핑하기</a>
</div>
</div>

<div id="error-content" style="display:none">
<div class="success-icon" style="color:#dc3545">
<i class="fa-solid fa-circle-xmark"></i>
</div>
<h1 style="color:#dc3545">결제 승인 실패</h1>
<p class="subtitle" id="error-message">결제 승인 중 오류가 발생했습니다.</p>
<div class="buttons">
<a href="cart.html" class="btn btn-primary">장바구니로</a>
<a href="index.html" class="btn btn-secondary">홈으로</a>
</div>
</div>
</div>

<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
// EmailJS 초기화 (나중에 본인의 Public Key로 변경)
emailjs.init('YOUR_PUBLIC_KEY'); // EmailJS에서 받은 Public Key 입력

// 판매자에게 주문 알림 이메일 발송
function sendOrderNotification(orderInfo, paymentResult) {
    const emailParams = {
        to_email: 'contact@minibolt.co.kr', // 판매자 이메일
        order_id: orderInfo.orderId,
        order_date: new Date(orderInfo.createdAt).toLocaleString('ko-KR'),
        buyer_name: orderInfo.buyerName,
        buyer_email: orderInfo.buyerEmail,
        buyer_phone: orderInfo.buyerPhone,
        receiver_name: orderInfo.receiverName,
        receiver_phone: orderInfo.receiverPhone,
        receiver_address: orderInfo.address,
        delivery_message: orderInfo.deliveryMessage || '없음',
        total_amount: '₩' + orderInfo.amount.toLocaleString(),
        payment_method: paymentResult.method === 'CARD' ? '신용카드' : paymentResult.method,
        items_list: orderInfo.items.map(item =>
            `${item.name} (M${item.diameter}×${item.length}mm, ${item.color}) - ${item.qty.toLocaleString()}개`
        ).join('\n')
    };

    emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', emailParams)
        .then(function(response) {
            console.log('주문 알림 이메일 발송 성공:', response.status, response.text);
        }, function(error) {
            console.error('이메일 발송 실패:', error);
        });
}

async function confirmPayment() {
    document.getElementById('loading').style.display = 'block';

    try {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentKey = urlParams.get('paymentKey');
        const orderId = urlParams.get('orderId');
        const amount = urlParams.get('amount');

        if (!paymentKey || !orderId || !amount) {
            throw new Error('결제 정보가 올바르지 않습니다.');
        }

        // ⚠️ 실제 배포 시에는 백엔드 서버에서 처리해야 합니다!
        // 여기서는 프론트엔드에서 직접 승인 요청 (테스트용)
        const response = await fetch('https://api.tosspayments.com/v1/payments/confirm', {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + btoa('test_sk_zXLkKEypNArWmo50nX3lmeaxYG5R:'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                paymentKey,
                orderId,
                amount: parseInt(amount)
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || '결제 승인에 실패했습니다.');
        }

        // 결제 성공 - 주문 정보 표시
        const orderInfo = JSON.parse(sessionStorage.getItem('orderInfo') || '{}');

        document.getElementById('order-id').textContent = orderId;
        document.getElementById('payment-method').textContent = result.method === 'CARD' ? '신용카드' : result.method;
        document.getElementById('amount').textContent = '₩' + parseInt(amount).toLocaleString();
        document.getElementById('buyer-name').textContent = orderInfo.buyerName || '-';

        // 판매자에게 이메일 알림 발송
        sendOrderNotification(orderInfo, result);

        // 주문 완료 후 장바구니 비우기
        localStorage.removeItem('cart');
        sessionStorage.removeItem('orderInfo');

        // 주문 내역 저장 (실제로는 서버에 저장)
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        orders.push({
            ...orderInfo,
            paymentKey,
            paymentMethod: result.method,
            status: 'COMPLETED',
            completedAt: new Date().toISOString()
        });
        localStorage.setItem('orders', JSON.stringify(orders));

        document.getElementById('loading').style.display = 'none';
        document.getElementById('success-content').style.display = 'block';

    } catch (error) {
        console.error('결제 승인 오류:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-content').style.display = 'block';
        document.getElementById('error-message').textContent = error.message;
    }
}

document.addEventListener('DOMContentLoaded', confirmPayment);
</script>
</body>
</html>
