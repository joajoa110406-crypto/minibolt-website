<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>로그인 처리중... - MiniBolt</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;color:#333;background:#f5f5f5;display:flex;align-items:center;justify-content:center;min-height:100vh}
.loading{text-align:center}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #ff6b35;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 1rem}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
h2{color:#ff6b35;margin-bottom:0.5rem}
p{color:#666}
.error{background:#fff;padding:2rem;border-radius:10px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
.error h2{color:#dc3545}
.error button{background:#ff6b35;color:#fff;border:none;padding:0.8rem 1.5rem;border-radius:6px;cursor:pointer;margin-top:1rem;font-weight:600}
</style>
</head>
<body>
<div class="loading" id="loading">
<div class="spinner"></div>
<h2>로그인 처리중...</h2>
<p>잠시만 기다려주세요</p>
</div>

<script>
const CLIENT_ID = 'GcQzjaicSpxlw1ElNJeE';
const CLIENT_SECRET = 'LL1njAX1pp';

async function handleCallback() {
    try {
        // URL에서 코드와 state 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDesc = urlParams.get('error_description');

        // 에러 체크
        if (error) {
            showError('로그인 취소', errorDesc || '사용자가 로그인을 취소했습니다.');
            return;
        }

        // State 검증 (CSRF 방지)
        const savedState = sessionStorage.getItem('naver_state');
        if (state !== savedState) {
            showError('보안 오류', 'State 값이 일치하지 않습니다.');
            return;
        }

        if (!code) {
            showError('인증 오류', '인증 코드를 받지 못했습니다.');
            return;
        }

        // ⚠️ 주의: 실제 배포 시에는 이 부분을 백엔드 서버에서 처리해야 합니다!
        // 토큰 발급 요청 (CORS 문제로 프록시 서버 필요)
        const tokenResponse = await fetch('https://nid.naver.com/oauth2.0/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                client_id: CLIENT_ID,
                client_secret: CLIENT_SECRET,
                code: code,
                state: state
            })
        });

        if (!tokenResponse.ok) {
            throw new Error('토큰 발급 실패');
        }

        const tokenData = await tokenResponse.json();

        if (tokenData.error) {
            showError('토큰 발급 오류', tokenData.error_description);
            return;
        }

        // 액세스 토큰으로 사용자 정보 가져오기
        const userResponse = await fetch('https://openapi.naver.com/v1/nid/me', {
            headers: {
                'Authorization': `Bearer ${tokenData.access_token}`
            }
        });

        const userData = await userResponse.json();

        if (userData.resultcode === '00') {
            // 로그인 성공 - 사용자 정보 저장
            const user = {
                id: userData.response.id,
                email: userData.response.email,
                name: userData.response.name,
                profile_image: userData.response.profile_image,
                access_token: tokenData.access_token
            };

            localStorage.setItem('user', JSON.stringify(user));
            sessionStorage.removeItem('naver_state');

            // 홈으로 리다이렉트
            alert(`${user.name}님 환영합니다!`);
            window.location.href = 'index.html';
        } else {
            showError('사용자 정보 조회 실패', userData.message);
        }

    } catch (error) {
        console.error('로그인 처리 오류:', error);
        showError('네트워크 오류', 'CORS 정책으로 인해 직접 API 호출이 제한됩니다. 백엔드 서버가 필요합니다.');
    }
}

function showError(title, message) {
    document.getElementById('loading').innerHTML = `
        <div class="error">
            <h2>${title}</h2>
            <p>${message}</p>
            <button onclick="window.location.href='login.html'">다시 시도</button>
        </div>
    `;
}

// 페이지 로드 시 콜백 처리
handleCallback();
</script>
</body>
</html>
